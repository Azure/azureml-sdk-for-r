<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Train and deploy your first model with Azure ML • azuremlsdk</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Train and deploy your first model with Azure ML">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">azuremlsdk</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/cnn-tuning-with-hyperdrive/cnn-tuning-with-hyperdrive.html">Hyperparameter Tuning a Keras Model with HyperDrive</a>
    </li>
    <li>
      <a href="../../articles/configuration.html">Set up an Azure ML workspace</a>
    </li>
    <li>
      <a href="../../articles/deploy-to-aks/deploy-to-aks.html">Deploying to AKS with Azure ML SDK for R</a>
    </li>
    <li>
      <a href="../../articles/installation.html">Installing AzureML SDK for R</a>
    </li>
    <li>
      <a href="../../articles/train-and-deploy-with-caret/train-and-deploy-with-caret.html">Train and deploy your first model with Azure ML</a>
    </li>
    <li>
      <a href="../../articles/train-with-tensorflow/train-with-tensorflow.html">Training a TensorFlow Model on MNIST</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/azure/azureml-sdk-for-r">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Train and deploy your first model with Azure ML</h1>
                        <h4 class="author">David Smith</h4>
            
            <h4 class="date">2019-10-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/azure/azureml-sdk-for-r/blob/master/vignettes/train-and-deploy-with-caret/train-and-deploy-with-caret.Rmd"><code>vignettes/train-and-deploy-with-caret/train-and-deploy-with-caret.Rmd</code></a></small>
      <div class="hidden name"><code>train-and-deploy-with-caret.Rmd</code></div>

    </div>

    
    
<p>In this tutorial, you learn the foundational design patterns in Azure Machine Learning. You’ll train and deploy a <strong>caret</strong> model to predict the likelihood of a fatality in an automobile accident. After completing this tutorial, you’ll have the practical knowledge of the R SDK to scale up to developing more-complex experiments and workflows.</p>
<p>In this tutorial, you learn the following tasks:</p>
<ul>
<li>Connect your workspace</li>
<li>Load data and prepare for training</li>
<li>Upload data to the datastore so it is available for remote training</li>
<li>Create a compute resource</li>
<li>Train a caret model to predict probability of fatality</li>
<li>Deploy a prediction endpoint</li>
<li>Test the model from R</li>
</ul>
<div id="prerequisites" class="section level2">
<h2 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h2>
<p>Follow the steps in <a href="https://docs.microsoft.com/azure/machine-learning/service/tutorial-1st-experiment-r-set-up">Tutorial: Get started with Azure Machine Learning and its R SDK</a> to get started using RStudio on a cloud-based compute instance in your Azure subscription. Everything you need is installed and configured for you on the compute instance.</p>
<p>If you are not using a compute instance, use the steps below to install on your own computer.</p>
<ol style="list-style-type: decimal">
<li>To use the Azure Machine Learning SDK for R, you also need Conda installed along with Python 3.5. Follow the <a href="https://azure.github.io/azureml-sdk-for-r/articles/installation.html">installation instructions</a>.</li>
</ol>
</div>
<div id="launch-rstudio-and-load-the-azureml-package" class="section level2">
<h2 class="hasAnchor">
<a href="#launch-rstudio-and-load-the-azureml-package" class="anchor"></a>Launch RStudio and load the azureml package</h2>
<p>We recommend using RStudio to run these examples. Launch RStudio and then:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(azuremlsdk)</a></code></pre></div>
<p>You’ll use these additional R packages:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"DAAG"</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"caret"</span>)</a></code></pre></div>
</div>
<div id="load-your-workspace" class="section level2">
<h2 class="hasAnchor">
<a href="#load-your-workspace" class="anchor"></a>Load your workspace</h2>
<p>Now define a workspace object in R by loading your config file.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">ws &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/load_workspace_from_config.html">load_workspace_from_config</a></span>()</a></code></pre></div>
</div>
<div id="load-data-and-prepare-for-training" class="section level2">
<h2 class="hasAnchor">
<a href="#load-data-and-prepare-for-training" class="anchor"></a>Load data and prepare for training</h2>
<p>This tutorial uses data from the <a href="https://cran.r-project.org/package=DAAG">DAAG package</a>. This dataset includes data from over 25,000 car crashes in the US, with variables you can use to predict the likelihood of a fatality. First, import the data into R and transform it into a new dataframe <code>accidents</code> for analysis, and export it to an <code>Rdata</code> file.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(DAAG)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(nassCDS)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">accidents &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span>(nassCDS[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"dead"</span>,<span class="st">"dvcat"</span>,<span class="st">"seatbelt"</span>,<span class="st">"frontal"</span>,<span class="st">"sex"</span>,<span class="st">"ageOFocc"</span>,<span class="st">"yearVeh"</span>,<span class="st">"airbag"</span>,<span class="st">"occRole"</span>)])</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">accidents<span class="op">$</span>frontal &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(accidents<span class="op">$</span>frontal, <span class="dt">labels=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"notfrontal"</span>,<span class="st">"frontal"</span>))</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">accidents<span class="op">$</span>occRole &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(accidents<span class="op">$</span>occRole)</a>
<a class="sourceLine" id="cb4-7" data-line-number="7"></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="kw"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(accidents, <span class="dt">file=</span><span class="st">"accidents.Rd"</span>)</a></code></pre></div>
</div>
<div id="upload-data-to-the-datastore" class="section level2">
<h2 class="hasAnchor">
<a href="#upload-data-to-the-datastore" class="anchor"></a>Upload data to the datastore</h2>
<p>Azure Machine Learning workspaces provide a default datastore where you can store data and other files needed for analysis. Here, upload the accidents data you created above to the datastore.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">ds &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/get_default_datastore.html">get_default_datastore</a></span>(ws)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">target_path &lt;-<span class="st"> "accidentdata"</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw"><a href="../../reference/upload_files_to_datastore.html">upload_files_to_datastore</a></span>(ds,</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">                          <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"./accidents.Rd"</span>),</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">                          <span class="dt">target_path =</span> target_path,</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">                          <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
</div>
<div id="create-a-compute-resource" class="section level2">
<h2 class="hasAnchor">
<a href="#create-a-compute-resource" class="anchor"></a>Create a compute resource</h2>
<p>When you need more power than your local laptop to train a model, create a compute resource. Here you create a virtual machine in Azure (and give it a name of <code>rcluster</code>) to use for training your model.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">cluster_name &lt;-<span class="st"> "rcluster"</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">compute_target &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/get_compute.html">get_compute</a></span>(ws, <span class="dt">cluster_name =</span> cluster_name)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="cf">if</span> (<span class="kw"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(compute_target)) {</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  vm_size &lt;-<span class="st"> "STANDARD_D2_V2"</span> </a>
<a class="sourceLine" id="cb6-5" data-line-number="5">  compute_target &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/create_aml_compute.html">create_aml_compute</a></span>(<span class="dt">workspace =</span> ws,</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">                                       <span class="dt">cluster_name =</span> cluster_name,</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">                                       <span class="dt">vm_size =</span> vm_size,</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">                                       <span class="dt">max_nodes =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">}</a></code></pre></div>
</div>
<div id="train-a-model" class="section level2">
<h2 class="hasAnchor">
<a href="#train-a-model" class="anchor"></a>Train a model</h2>
<p>Now fit a logistic regression model on your uploaded data using your remote compute target.</p>
<blockquote>
<p>NOTE You may need to wait a few minutes for your compute cluster to be provisioned before moving on to the next step.</p>
</blockquote>
<p>The script to fit the model is called <code>accidents.R</code>. It will be run as a command-line script with <code>Rscript</code>. <code>Rscript</code> takes one argument, <code>-d</code> to specify the storage folder where the data file is located. The argument will be provided for you by Azure Machine Learning.</p>
<p>To run the training script:</p>
<ul>
<li>Create an <code>estimator</code> object to specify the script file name, parameters for the script file, and other options. The code below uses the compute cluster to run the script. The <code>cran_packages</code> option defines the packages to be installed on the compute cluster for R to use.</li>
<li>Create an <code>experiment</code> to start the computation.</li>
<li>Submit the experiment and wait until it’s finished.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">est &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/estimator.html">estimator</a></span>(<span class="dt">source_directory =</span> <span class="st">"."</span>,</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">                 <span class="dt">entry_script =</span> <span class="st">"accidents.R"</span>,</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">                 <span class="dt">script_params =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"--data_folder"</span> =<span class="st"> </span>ds<span class="op">$</span><span class="kw">path</span>(target_path)),</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">                 <span class="dt">compute_target =</span> compute_target,</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">                 <span class="dt">cran_packages =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"caret"</span>, <span class="st">"optparse"</span>, <span class="st">"e1071"</span>)</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">                 )</a>
<a class="sourceLine" id="cb7-7" data-line-number="7"></a>
<a class="sourceLine" id="cb7-8" data-line-number="8">experiment_name &lt;-<span class="st"> "accident-logreg"</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9">exp &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/experiment.html">experiment</a></span>(ws, experiment_name)</a>
<a class="sourceLine" id="cb7-10" data-line-number="10"></a>
<a class="sourceLine" id="cb7-11" data-line-number="11">run &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/submit_experiment.html">submit_experiment</a></span>(exp, est)</a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="kw"><a href="../../reference/view_run_details.html">view_run_details</a></span>(run)</a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="kw"><a href="../../reference/wait_for_run_completion.html">wait_for_run_completion</a></span>(run, <span class="dt">show_output =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>(You – and colleagues with access to the workspace – can submit multiple experiments in parallel, and Azure Machine Learning will take of scheduling the tasks on the compute cluster. You can even configure the cluster to automatically scale up to multiple nodes, and scale back when there are no more compute tasks in the queue. This configuration is a cost-effective way for teams to share compute resources.)</p>
<p>In the file <code>accidents.R</code>, you stored a metric from your model: the accuracy of the predictions in the training data. (You can store any metrics you like.)</p>
<p>You can see metrics in your workspace in <a href="https://ml.azure.com">Azure Machine Learning studio</a>, or extract them to the local session as an R list as follows:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">metrics &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/get_run_metrics.html">get_run_metrics</a></span>(run)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">metrics</a></code></pre></div>
<blockquote>
<p>NOTE If you’ve run multiple experiments (say, using differing variables, algorithms, or hyperparamers), you can use the metrics from each run to choose the model you’ll use in production.</p>
</blockquote>
</div>
<div id="retrieve-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#retrieve-the-model" class="anchor"></a>Retrieve the model</h2>
<p>Now that you’ve fit the logistic regression model in the remote compute resource, you can retrieve the model object and look at the results in your local R session.</p>
<p>You see some factors that contribute to an increase in the estimated probability of death:</p>
<ul>
<li>higher impact speed</li>
<li>male driver</li>
<li>older occupant</li>
<li>passenger</li>
</ul>
<p>You see lower probabilities of death with:</p>
<ul>
<li>presence of airbags</li>
<li>presence seatbelts</li>
<li>frontal collision</li>
</ul>
<p>The vehicle year of manufacture does not have a significant effect.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="../../reference/download_files_from_run.html">download_files_from_run</a></span>(run, <span class="dt">prefix=</span><span class="st">"outputs/"</span>)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">accident_model &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"outputs/model.rds"</span>)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(accident_model)</a></code></pre></div>
<p>You can use this model to make new predictions:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">newdata &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>( <span class="co"># valid values shown below</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"> <span class="dt">dvcat=</span><span class="st">"10-24"</span>,        <span class="co"># "1-9km/h" "10-24"   "25-39"   "40-54"   "55+"  </span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"> <span class="dt">seatbelt=</span><span class="st">"none"</span>,      <span class="co"># "none"   "belted"  </span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"> <span class="dt">frontal=</span><span class="st">"frontal"</span>,    <span class="co"># "notfrontal" "frontal"</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"> <span class="dt">sex=</span><span class="st">"f"</span>,              <span class="co"># "f" "m"</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"> <span class="dt">ageOFocc=</span><span class="dv">16</span>,          <span class="co"># age in years, 16-97</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"> <span class="dt">yearVeh=</span><span class="dv">2002</span>,         <span class="co"># year of vehicle, 1955-2003</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"> <span class="dt">airbag=</span><span class="st">"none"</span>,        <span class="co"># "none"   "airbag"   </span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"> <span class="dt">occRole=</span><span class="st">"pass"</span>        <span class="co"># "driver" "pass"</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"> )</a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="co">## predicted probability of death for these variables, as a percentage</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(accident_model,newdata, <span class="dt">type=</span><span class="st">"response"</span>)<span class="op">*</span><span class="dv">100</span>)</a></code></pre></div>
</div>
<div id="deploy-a-prediction-endpoint" class="section level2">
<h2 class="hasAnchor">
<a href="#deploy-a-prediction-endpoint" class="anchor"></a>Deploy a prediction endpoint</h2>
<p>With your model, you can predict the danger death from of other types of collisions. Use Azure Machine Learning to deploy your model as a prediction service, and then call the model from a Shiny app.</p>
<p>First, register the model you downloaded for deployment:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">model &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/register_model.html">register_model</a></span>(ws, </a>
<a class="sourceLine" id="cb11-2" data-line-number="2">                        <span class="dt">model_path =</span> <span class="st">"outputs/model.rds"</span>, </a>
<a class="sourceLine" id="cb11-3" data-line-number="3">                        <span class="dt">model_name =</span> <span class="st">"accidents_model"</span>,</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">                        <span class="dt">description =</span> <span class="st">"Predict probablity of auto accident"</span>)</a></code></pre></div>
<p>A registered model can be any collection of files, but in this case the R model object is sufficient. Azure Machine Learning will track models each time they are deployed, which is our next step.</p>
<p>To create a web service for your model, you first need to create an <strong>entry script</strong>: an R script that will take as input variable values (in JSON format) and output a prediction from your model. Use the file <code>accident_predict.R</code>.</p>
<p>Next, define an <strong>environment</strong> for your deployed model. With an environment, you specify R packages (from CRAN or elsewhere) that are needed for your entry script to run. You also provide the values of environment variables that your script can reference to modify its behavior. If you need software other than R to be available, specify a custom Docker image to use. In this tutorial, there are no special requirements, so create an environment with no special attributes:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">r_env &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/r_environment.html">r_environment</a></span>(<span class="dt">name =</span> <span class="st">"basic_env"</span>)</a></code></pre></div>
<p>Now you have everything you need to create an <strong>inference config</strong>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">inference_config &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/inference_config.html">inference_config</a></span>(</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">  <span class="dt">entry_script =</span> <span class="st">"accident_predict.R"</span>,</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">  <span class="dt">source_directory =</span> <span class="st">"."</span>,</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">  <span class="dt">environment =</span> r_env)</a></code></pre></div>
<p>You’ll deploy your service to Azure Container Instances. This code provisions a single container to respond to inbound requests, which is suitable for testing and light loads. (For production scale, you can also deploy to Azure Kubernetes Service.)</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">aci_config &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/aci_webservice_deployment_config.html">aci_webservice_deployment_config</a></span>(<span class="dt">cpu_cores =</span> <span class="dv">1</span>, <span class="dt">memory_gb =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<p>Now you deploy your service.</p>
<blockquote>
<p>NOTE Deployment can take several minutes.</p>
</blockquote>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">aci_service &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/deploy_model.html">deploy_model</a></span>(ws, </a>
<a class="sourceLine" id="cb15-2" data-line-number="2">                        <span class="st">'accident-pred'</span>, </a>
<a class="sourceLine" id="cb15-3" data-line-number="3">                        <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(model), </a>
<a class="sourceLine" id="cb15-4" data-line-number="4">                        inference_config, </a>
<a class="sourceLine" id="cb15-5" data-line-number="5">                        aci_config)</a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="kw"><a href="../../reference/wait_for_deployment.html">wait_for_deployment</a></span>(aci_service, <span class="dt">show_output =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
</div>
<div id="test-the-model-from-r" class="section level2">
<h2 class="hasAnchor">
<a href="#test-the-model-from-r" class="anchor"></a>Test the model from R</h2>
<p>Now that your model is deployed as a service, you can test the service from R. Provide a new set of data to predict from, convert it to JSON, and send it to the service.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">newdata &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>( <span class="co"># valid values shown below</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"> <span class="dt">dvcat=</span><span class="st">"10-24"</span>,        <span class="co"># "1-9km/h" "10-24"   "25-39"   "40-54"   "55+"  </span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"> <span class="dt">seatbelt=</span><span class="st">"none"</span>,      <span class="co"># "none"   "belted"  </span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"> <span class="dt">frontal=</span><span class="st">"frontal"</span>,    <span class="co"># "notfrontal" "frontal"</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5"> <span class="dt">sex=</span><span class="st">"f"</span>,              <span class="co"># "f" "m"</span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"> <span class="dt">ageOFocc=</span><span class="dv">22</span>,          <span class="co"># age in years, 16-97</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"> <span class="dt">yearVeh=</span><span class="dv">2002</span>,         <span class="co"># year of vehicle, 1955-2003</span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"> <span class="dt">airbag=</span><span class="st">"none"</span>,        <span class="co"># "none"   "airbag"   </span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"> <span class="dt">occRole=</span><span class="st">"pass"</span>        <span class="co"># "driver" "pass"</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"> )</a>
<a class="sourceLine" id="cb16-11" data-line-number="11">prob &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/invoke_webservice.html">invoke_webservice</a></span>(aci_service, <span class="kw">toJSON</span>(newdata))</a>
<a class="sourceLine" id="cb16-12" data-line-number="12">prob</a></code></pre></div>
</div>
<div id="clean-up-resources" class="section level2">
<h2 class="hasAnchor">
<a href="#clean-up-resources" class="anchor"></a>Clean up resources</h2>
<p>Do not complete this section if you plan on running other Azure Machine Learning tutorials.</p>
<div id="stop-the-compute-instance" class="section level3">
<h3 class="hasAnchor">
<a href="#stop-the-compute-instance" class="anchor"></a>Stop the compute instance</h3>
<p>If you used a compute instance, stop the VM when you are not using it to reduce cost.</p>
<ol style="list-style-type: decimal">
<li>In your workspace, select <strong>Compute</strong>.</li>
<li>From the list, select the VM.</li>
<li>Select <strong>Stop</strong>.</li>
<li>When you’re ready to use the server again, select <strong>Start</strong>.</li>
</ol>
</div>
<div id="delete-everything" class="section level3">
<h3 class="hasAnchor">
<a href="#delete-everything" class="anchor"></a>Delete everything</h3>
<blockquote>
<p>IMPORTANT The resources you created can be used as prerequisites to other Azure Machine Learning service tutorials and how-to articles.</p>
</blockquote>
<p>If you don’t plan to use the resources you created, delete them, so you don’t incur any charges:</p>
<ol style="list-style-type: decimal">
<li>In the Azure portal, select <strong>Resource groups</strong> on the far left.</li>
<li>From the list, select the resource group you created.</li>
<li>Select <strong>Delete resource group</strong>.</li>
<li>Enter the resource group name. Then select <strong>Delete</strong>.</li>
</ol>
<p>You can also keep the resource group but delete a single workspace. Display the workspace properties and select <strong>Delete</strong>.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#prerequisites">Prerequisites</a></li>
      <li><a href="#launch-rstudio-and-load-the-azureml-package">Launch RStudio and load the azureml package</a></li>
      <li><a href="#load-your-workspace">Load your workspace</a></li>
      <li><a href="#load-data-and-prepare-for-training">Load data and prepare for training</a></li>
      <li><a href="#upload-data-to-the-datastore">Upload data to the datastore</a></li>
      <li><a href="#create-a-compute-resource">Create a compute resource</a></li>
      <li><a href="#train-a-model">Train a model</a></li>
      <li><a href="#retrieve-the-model">Retrieve the model</a></li>
      <li><a href="#deploy-a-prediction-endpoint">Deploy a prediction endpoint</a></li>
      <li><a href="#test-the-model-from-r">Test the model from R</a></li>
      <li><a href="#clean-up-resources">Clean up resources</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Himanshu Chandola, Billy Hu, Heemanshu Suri, Diondra Peck, Microsoft.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>

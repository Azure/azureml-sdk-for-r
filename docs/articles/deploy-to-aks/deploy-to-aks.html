<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deploying to AKS with Azure ML SDK for R • azuremlsdk</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Deploying to AKS with Azure ML SDK for R">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">azuremlsdk</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/cnn-tuning-with-hyperdrive/cnn-tuning-with-hyperdrive.html">Hyperparameter Tuning a Keras Model with HyperDrive</a>
    </li>
    <li>
      <a href="../../articles/configuration.html">Set up an Azure ML workspace</a>
    </li>
    <li>
      <a href="../../articles/deploy-to-aks/deploy-to-aks.html">Deploying to AKS with Azure ML SDK for R</a>
    </li>
    <li>
      <a href="../../articles/installation.html">Install the Azure ML SDK for R</a>
    </li>
    <li>
      <a href="../../articles/train-and-deploy-to-aci/train-and-deploy-to-aci.html">Train and deploy your first model with Azure ML</a>
    </li>
    <li>
      <a href="../../articles/train-with-tensorflow/train-with-tensorflow.html">Training a TensorFlow Model on MNIST</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/azure/azureml-sdk-for-r">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Deploying to AKS with Azure ML SDK for R</h1>
            
            <h4 class="date">2019-10-24</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/azure/azureml-sdk-for-r/blob/master/vignettes/deploy-to-aks/deploy-to-aks.Rmd"><code>vignettes/deploy-to-aks/deploy-to-aks.Rmd</code></a></small>
      <div class="hidden name"><code>deploy-to-aks.Rmd</code></div>

    </div>

    
    
<p>This article demonstrates how to deploy a model and conduct inferencing in the model using AzureML SDK for R. We will take a previously saved <a href="https://github.com/Azure/azureml-sdk-for-r/blob/master/samples/training/train-on-amlcompute/train-on-amlcompute.R">model</a>. The saved model was trained with the Iris Dataset and can be used to determine if a flower is one of three Iris flower species (setosa, versicolor, virginica).</p>
<p>We will show you how to:</p>
<ol start="0" style="list-style-type: decimal">
<li><p>Set up the experiment</p></li>
<li><p>Register a model on Azure ML</p></li>
<li><p>Create the deployment environment</p></li>
<li><p>Create the inferencing configurations</p></li>
<li><p>Provision an AKS cluster</p></li>
<li><p>Deploy the model as a service to the AKS cluster</p></li>
<li><p>Conduct inferencing on the deployed service.</p></li>
</ol>
<div id="set-up-the-experiment" class="section level2">
<h2 class="hasAnchor">
<a href="#set-up-the-experiment" class="anchor"></a>0. Set up the experiment</h2>
<p>Let’s prepare for training by loading the required package, initializing a workspace, and creating an experiment.</p>
<div id="import-package" class="section level3">
<h3 class="hasAnchor">
<a href="#import-package" class="anchor"></a>Import package</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"azureml"</span>)</a></code></pre></div>
</div>
<div id="initialize-a-workspace" class="section level3">
<h3 class="hasAnchor">
<a href="#initialize-a-workspace" class="anchor"></a>Initialize a workspace</h3>
<p>The <code>Workspace</code> is the top-level resource for the service. It provides us with a centralized place to work with all the artifacts we will create.</p>
<p>You can create a <code>Workspace</code> object from a local <code>config.json</code> file</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">ws &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/load_workspace_from_config.html">load_workspace_from_config</a></span>()</a></code></pre></div>
<p>Or load an existing workspace from your Azure Machine Learning account</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">ws &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/get_workspace.html">get_workspace</a></span>(<span class="st">"&lt;your workspace name&gt;"</span>, <span class="st">"&lt;your subscription ID&gt;"</span>, <span class="st">"&lt;your resource group&gt;"</span>)</a></code></pre></div>
</div>
</div>
<div id="register-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#register-the-model" class="anchor"></a>1. Register the model</h2>
<p>For this example, register an existing trained model, add name and description.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">model &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/register_model.html">register_model</a></span>(ws, </a>
<a class="sourceLine" id="cb4-2" data-line-number="2">                        <span class="dt">model_path =</span> <span class="st">"model.rds"</span>, </a>
<a class="sourceLine" id="cb4-3" data-line-number="3">                        <span class="dt">model_name =</span> <span class="st">"iris_model"</span>,</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">                        <span class="dt">description =</span> <span class="st">"Predict an Iris flower type"</span>)</a></code></pre></div>
</div>
<div id="create-environment" class="section level2">
<h2 class="hasAnchor">
<a href="#create-environment" class="anchor"></a>2. Create environment</h2>
<p>Create an environment that the model will be deployed with</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">r_env &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/r_environment.html">r_environment</a></span>(<span class="dt">name =</span> <span class="st">"r_env"</span>)</a></code></pre></div>
</div>
<div id="create-inference-config" class="section level2">
<h2 class="hasAnchor">
<a href="#create-inference-config" class="anchor"></a>3. Create inference config</h2>
<p>Create the inference config that will be used when deploying the model.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">inference_config &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/inference_config.html">inference_config</a></span>(</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="dt">entry_script =</span> <span class="st">"score.R"</span>,</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  <span class="dt">source_directory =</span> <span class="st">"."</span>,</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  <span class="dt">environment =</span> r_env)</a></code></pre></div>
</div>
<div id="provision-aks-cluster" class="section level2">
<h2 class="hasAnchor">
<a href="#provision-aks-cluster" class="anchor"></a>4. Provision AKS cluster</h2>
<p>This is a one time setup. You can reuse this cluster for multiple deployments after it has been created. If you delete the cluster or the resource group that contains it, then you would have to recreate it.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">aks_target &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/create_aks_compute.html">create_aks_compute</a></span>(ws, <span class="dt">cluster_name =</span> <span class="st">'my-new-cluster'</span>)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw"><a href="../../reference/wait_for_provisioning_completion.html">wait_for_provisioning_completion</a></span>(aks_target)</a></code></pre></div>
</div>
<div id="deploy-the-model-to-aks-and-waiting-for-deployment" class="section level2">
<h2 class="hasAnchor">
<a href="#deploy-the-model-to-aks-and-waiting-for-deployment" class="anchor"></a>5. Deploy the model to AKS and waiting for deployment</h2>
<p>Set the web service configuration.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">aks_config &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/aks_webservice_deployment_config.html">aks_webservice_deployment_config</a></span>(<span class="dt">cpu_cores =</span> <span class="dv">1</span>, <span class="dt">memory_gb =</span> <span class="dv">1</span>)</a></code></pre></div>
<p>Deploy web service to AKS Cluster</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">aks_service &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/deploy_model.html">deploy_model</a></span>(ws, </a>
<a class="sourceLine" id="cb9-2" data-line-number="2">                        <span class="st">'my-new-aksrservice'</span>, </a>
<a class="sourceLine" id="cb9-3" data-line-number="3">                        <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(model), </a>
<a class="sourceLine" id="cb9-4" data-line-number="4">                        inference_config, </a>
<a class="sourceLine" id="cb9-5" data-line-number="5">                        aks_config,</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">                        aks_target)</a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="kw"><a href="../../reference/wait_for_deployment.html">wait_for_deployment</a></span>(aks_service, <span class="dt">show_output =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
</div>
<div id="test-inferencing-on-deployed-service" class="section level2">
<h2 class="hasAnchor">
<a href="#test-inferencing-on-deployed-service" class="anchor"></a>6. Test Inferencing on deployed service</h2>
<p>We test the web service by passing data for a specific type of Iris.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># If you encounter any issue in deploying the webservice, please visit</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co"># https://docs.microsoft.com/en-us/azure/machine-learning/service/how-to-troubleshoot-deployment</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co"># Inferencing</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co"># versicolor</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">plant &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">Sepal.Length =</span> <span class="fl">6.4</span>,</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">                    <span class="dt">Sepal.Width =</span> <span class="fl">2.8</span>,</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">                    <span class="dt">Petal.Length =</span> <span class="fl">4.6</span>,</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">                    <span class="dt">Petal.Width =</span> <span class="fl">1.8</span>)</a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="co"># setosa</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="co"># plant &lt;- data.frame(Sepal.Length = 5.1,</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="co">#                    Sepal.Width = 3.5,</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="co">#                    Petal.Length = 1.4,</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="co">#                    Petal.Width = 0.2)</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="co"># virginica</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="co"># plant &lt;- data.frame(Sepal.Length = 6.7,</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18"><span class="co">#                    Sepal.Width = 3.3,</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19"><span class="co">#                    Petal.Length = 5.2,</span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20"><span class="co">#                    Petal.Width = 2.3)</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21"></a>
<a class="sourceLine" id="cb10-22" data-line-number="22">predicted_val &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/invoke_webservice.html">invoke_webservice</a></span>(aks_service, <span class="kw">toJSON</span>(plant))</a>
<a class="sourceLine" id="cb10-23" data-line-number="23"><span class="kw"><a href="https://rdrr.io/r/base/message.html">message</a></span>(predicted_val)</a></code></pre></div>
<p>The result is “versicolor”, the model was able to predict the correct type of Iris.</p>
</div>
<div id="service-clean-up" class="section level2">
<h2 class="hasAnchor">
<a href="#service-clean-up" class="anchor"></a>6. Service clean up</h2>
<p>Delete the service and model.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="../../reference/delete_webservice.html">delete_webservice</a></span>(aks_service)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw"><a href="../../reference/delete_model.html">delete_model</a></span>(model)</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#set-up-the-experiment">0. Set up the experiment</a></li>
      <li><a href="#register-the-model">1. Register the model</a></li>
      <li><a href="#create-environment">2. Create environment</a></li>
      <li><a href="#create-inference-config">3. Create inference config</a></li>
      <li><a href="#provision-aks-cluster">4. Provision AKS cluster</a></li>
      <li><a href="#deploy-the-model-to-aks-and-waiting-for-deployment">5. Deploy the model to AKS and waiting for deployment</a></li>
      <li><a href="#test-inferencing-on-deployed-service">6. Test Inferencing on deployed service</a></li>
      <li><a href="#service-clean-up">6. Service clean up</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Himanshu Chandola, Billy Hu, Heemanshu Suri, Diondra Peck, Microsoft.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Training a TensorFlow Model on MNIST • azureml</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Training a TensorFlow Model on MNIST">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">azureml</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/hyperdrive_example.html">Hyperparameter Tuning a Keras Model with HyperDrive</a>
    </li>
    <li>
      <a href="../articles/installation.html">Installing AzureML SDK for R</a>
    </li>
    <li>
      <a href="../articles/tensorflow_example.html">Training a TensorFlow Model on MNIST</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/azure/azureml-sdk-for-r">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Training a TensorFlow Model on MNIST</h1>
            
            <h4 class="date">2019-09-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/azure/azureml-sdk-for-r/blob/master/vignettes/tensorflow_example.Rmd"><code>vignettes/tensorflow_example.Rmd</code></a></small>
      <div class="hidden name"><code>tensorflow_example.Rmd</code></div>

    </div>

    
    
<p>This article demonstrates how to run a TensorFlow training script at scale using AzureML SDK for R. We will train a TensorFlow model to classify handwritten digits using a deep neural network (DNN) and log our results to the Azure Machine Learning service.</p>
<div id="set-up-the-experiment" class="section level2">
<h2 class="hasAnchor">
<a href="#set-up-the-experiment" class="anchor"></a>1. Set up the experiment</h2>
<p>Let’s prepare for training by loading the required package, initializing a workspace, and creating an experiment.</p>
<div id="import-package" class="section level3">
<h3 class="hasAnchor">
<a href="#import-package" class="anchor"></a>Import package</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"azureml"</span>)</a></code></pre></div>
</div>
<div id="initialize-a-workspace" class="section level3">
<h3 class="hasAnchor">
<a href="#initialize-a-workspace" class="anchor"></a>Initialize a workspace</h3>
<p>The <code>Workspace</code> is the top-level resource for the service. It provides us with a centralized place to work with all the artifacts we will create.</p>
<p>You can create a <code>Workspace</code> object from a local <code>config.json</code> file</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">ws &lt;-<span class="st"> </span><span class="kw"><a href="../reference/load_workspace_from_config.html">load_workspace_from_config</a></span>()</a></code></pre></div>
<p>Or load an existing workspace from your Azure Machine Learning account</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">ws &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_workspace.html">get_workspace</a></span>(<span class="st">"&lt;your workspace name&gt;"</span>, <span class="st">"&lt;your subscription ID&gt;"</span>, <span class="st">"&lt;your resource group&gt;"</span>)</a></code></pre></div>
</div>
<div id="create-a-deep-learning-experiment" class="section level3">
<h3 class="hasAnchor">
<a href="#create-a-deep-learning-experiment" class="anchor"></a>Create a deep learning experiment</h3>
<p>For this example, we will create an <code>Experiment</code> called “tf-mnist”.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">exp &lt;-<span class="st"> </span><span class="kw">Experiment</span>(<span class="dt">workspace =</span> ws, <span class="dt">name =</span> <span class="st">'tf-mnist'</span>)</a></code></pre></div>
</div>
</div>
<div id="create-a-compute-target" class="section level2">
<h2 class="hasAnchor">
<a href="#create-a-compute-target" class="anchor"></a>2. Create a compute target</h2>
<p>Now, we will create a compute target for our TensorFlow job to run on. In this example, we are creating a CPU-enabled compute cluster.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">cluster_name &lt;-<span class="st"> "rcluster"</span></a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3">compute_target &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_compute.html">get_compute</a></span>(ws, <span class="dt">cluster_name =</span> cluster_name)</a>
<a class="sourceLine" id="cb5-4" title="4"><span class="cf">if</span> (<span class="kw"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(compute_target))</a>
<a class="sourceLine" id="cb5-5" title="5">{</a>
<a class="sourceLine" id="cb5-6" title="6">  vm_size &lt;-<span class="st"> "STANDARD_D2_V2"</span></a>
<a class="sourceLine" id="cb5-7" title="7">  compute_target &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_aml_compute.html">create_aml_compute</a></span>(<span class="dt">workspace =</span> ws, <span class="dt">cluster_name =</span> cluster_name,</a>
<a class="sourceLine" id="cb5-8" title="8">                                       <span class="dt">vm_size =</span> vm_size, <span class="dt">max_nodes =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-9" title="9">}</a>
<a class="sourceLine" id="cb5-10" title="10"></a>
<a class="sourceLine" id="cb5-11" title="11"><span class="kw"><a href="../reference/wait_for_compute.html">wait_for_compute</a></span>(compute_target)</a></code></pre></div>
</div>
<div id="prepare-training-script" class="section level2">
<h2 class="hasAnchor">
<a href="#prepare-training-script" class="anchor"></a>3. Prepare training script</h2>
<p>In order to collect and upload run metrics, we need to import the <code>azureml</code> package at the top of our training script, <a href="../../samples/training/train-with-tensorflow/tf_mnist.R">“tf_mnist.R”</a>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"azureml"</span>)</a></code></pre></div>
<p>Then, we need to add the <code>log_metric_to_run</code> function to track our primary metric, “accuracy”, for this experiment. If you have your own training script with several important metrics, simply create a logging call for each one within the script.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">current_run &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_current_run.html">get_current_run</a></span>()</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw"><a href="../reference/log_metric_to_run.html">log_metric_to_run</a></span>(<span class="st">"accuracy"</span>,</a>
<a class="sourceLine" id="cb7-3" title="3">                  sess<span class="op">$</span><span class="kw">run</span>(accuracy,</a>
<a class="sourceLine" id="cb7-4" title="4">                  <span class="dt">feed_dict =</span> <span class="kw">dict</span>(<span class="dt">x =</span> mnist<span class="op">$</span>test<span class="op">$</span>images, <span class="dt">y_ =</span> mnist<span class="op">$</span>test<span class="op">$</span>labels)),</a>
<a class="sourceLine" id="cb7-5" title="5">                  current_run)</a></code></pre></div>
</div>
<div id="create-an-estimator" class="section level2">
<h2 class="hasAnchor">
<a href="#create-an-estimator" class="anchor"></a>4. Create an estimator</h2>
<p>An <code>Estimator</code> offers a simple way to launch a training job on a compute target. Our training script will need the TensorFlow package to run, and we can have it installed in the Docker container where our job will run by passing the package name to the <code>cran_packages</code> parameter.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">est &lt;-<span class="st"> </span><span class="kw"><a href="../reference/estimator.html">estimator</a></span>(<span class="dt">source_directory =</span> <span class="st">"."</span>,</a>
<a class="sourceLine" id="cb8-2" title="2">                 <span class="dt">entry_script =</span> <span class="st">"tf_mnist.R"</span>,</a>
<a class="sourceLine" id="cb8-3" title="3">                 <span class="dt">compute_target =</span> compute_target,</a>
<a class="sourceLine" id="cb8-4" title="4">                 <span class="dt">cran_packages =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"tensorflow"</span>))</a></code></pre></div>
</div>
<div id="submit-a-run" class="section level2">
<h2 class="hasAnchor">
<a href="#submit-a-run" class="anchor"></a>5. Submit a run</h2>
<p>Submitting our experiment will return a <code>Run</code> object that we will use to interface with the run history during and after the job.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">run &lt;-<span class="st"> </span><span class="kw"><a href="../reference/submit_experiment.html">submit_experiment</a></span>(est, exp)</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw"><a href="../reference/wait_for_run_completion.html">wait_for_run_completion</a></span>(run, <span class="dt">show_output =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div id="view-metrics" class="section level3">
<h3 class="hasAnchor">
<a href="#view-metrics" class="anchor"></a>6. View metrics</h3>
<p>Finally, we can view the metrics collected during our TensorFlow run!</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">metrics &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_run_metrics.html">get_run_metrics</a></span>(run)</a>
<a class="sourceLine" id="cb10-2" title="2">metrics</a></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#set-up-the-experiment">1. Set up the experiment</a></li>
      <li><a href="#create-a-compute-target">2. Create a compute target</a></li>
      <li><a href="#prepare-training-script">3. Prepare training script</a></li>
      <li><a href="#create-an-estimator">4. Create an estimator</a></li>
      <li><a href="#submit-a-run">5. Submit a run</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Himanshu Chandola, Billy Hu, Heemanshu Suri, Diondra Peck, Microsoft.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Deeper Dive into Experiments • azuremlsdk</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="A Deeper Dive into Experiments">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">azuremlsdk</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.6.85</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/installation.html">Install the Azure ML SDK for R</a>
    </li>
    <li>
      <a href="../articles/configuration.html">Set up an Azure ML workspace</a>
    </li>
    <li>
      <a href="../articles/train-and-deploy-first-model.html">Train and deploy your first model with Azure ML</a>
    </li>
    <li>
      <a href="../articles/train-with-tensorflow.html">Train a TensorFlow model</a>
    </li>
    <li>
      <a href="../articles/hyperparameter-tune-with-keras.html">Hyperparameter tune a Keras model</a>
    </li>
    <li>
      <a href="../articles/deploy-to-aks.html">Deploy a web service to Azure Kubernetes Service</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Guides</li>
    <li>
      <a href="../articles/deploying-models.html">Deploying models</a>
    </li>
    <li>
      <a href="../articles/troubleshooting.html">Troubleshooting</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/azure/azureml-sdk-for-r">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>A Deeper Dive into Experiments</h1>
            
            <h4 class="date">2020-05-12</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/azure/azureml-sdk-for-r/blob/master/vignettes/experiments-deep-dive.Rmd"><code>vignettes/experiments-deep-dive.Rmd</code></a></small>
      <div class="hidden name"><code>experiments-deep-dive.Rmd</code></div>

    </div>

    
    
<div id="a-deeper-dive-into-experiments" class="section level2">
<h2 class="hasAnchor">
<a href="#a-deeper-dive-into-experiments" class="anchor"></a>A Deeper Dive into Experiments</h2>
<p>In this vignette, we will go into more details about experiments.</p>
<ul>
<li>Work with multiple experiments</li>
<li>Control experiments with command line arguments</li>
<li>Track multiple metrics</li>
<li>Use caret to train models and deploy as a web service</li>
</ul>
<p>We will use the <code>accidents</code> data, which was saved to your shared data store in the vignette “Train and deploy your first model with Azure ML”. We will also use the cluster <code>rcluster</code> created in that same vignette. Run that vignette first (at least through the section “Upload data to the datastore”), or the following commands will not work.</p>
</div>
<div id="load-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#load-the-data" class="anchor"></a>Load the data</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(azuremlsdk)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">ws &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/load_workspace_from_config.html">load_workspace_from_config</a></span>()</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">ds &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/get_default_datastore.html">get_default_datastore</a></span>(ws)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">target_path &lt;-<span class="st"> "accidentdata"</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/download_from_datastore.html">download_from_datastore</a></span>(ds, <span class="dt">target_path=</span><span class="st">"."</span>, <span class="dt">prefix=</span><span class="st">"accidentdata"</span>)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="co">## Find the compute target</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">cluster_name &lt;-<span class="st"> "rcluster"</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">compute_target &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/get_compute.html">get_compute</a></span>(ws, <span class="dt">cluster_name =</span> cluster_name)</a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="cf">if</span>(<span class="kw"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(compute_target)) <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"Training cluster not found"</span>)</a></code></pre></div>
</div>
<div id="try-out-several-models" class="section level2">
<h2 class="hasAnchor">
<a href="#try-out-several-models" class="anchor"></a>Try out several models</h2>
<p>We have provided three different experiment files in the <code>experiments-deep-dive</code> folder: <a href="accident-glm.R"><code>accident-glm.R</code></a>, <a href="accident-knn.R"><code>accident-knn.R</code></a>, <a href="accident-glmnet.R"><code>accident-glmnet.R</code></a>. Each uses the <code>caret</code> package to fit a predictive model to the accidents data (GLM, KNN and GLMNET respectively). Here are the parts of <code>accident-glm.R</code> that load the data and fit the model.</p>
<p>The script loads the data <code>accidents</code> from the shared datastore, and then creates a training partition <code>accident_trn</code>. This data is then passed to the caret <code>train</code> function to fit a generalized linear model (in this case, a logistic regression).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">### FROM FILE: accident-glm.R - do not run this code chunk</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co">## Caret GLM model on training set with 5-fold cross validation</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">accident_glm_mod &lt;-<span class="st"> </span><span class="kw">train</span>(</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  <span class="dt">form =</span> dead <span class="op">~</span><span class="st"> </span>.,</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  <span class="dt">data =</span> accident_trn,</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  <span class="dt">trControl =</span> <span class="kw">trainControl</span>(<span class="dt">method =</span> <span class="st">"cv"</span>, <span class="dt">number =</span> <span class="dv">5</span>),</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">  <span class="dt">method =</span> <span class="st">"glm"</span>,</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">  <span class="dt">family =</span> <span class="st">"binomial"</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">)</a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(accident_glm_mod)</a></code></pre></div>
<p>The <code>summary</code> command at the end generates output, which you can view in the experiment logs saved to Azure ML.</p>
<p>We will make several training runs, and save and track the results in a new experiment, called <code>accident</code>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">exp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/experiment.html">experiment</a></span>(ws, <span class="st">"accident"</span>)</a></code></pre></div>
<p>Now, train the GLM model by submitting the script <code>accident-glm.R</code> to the experiment.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">est &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/estimator.html">estimator</a></span>(<span class="dt">source_directory=</span><span class="st">"experiments-deep-dive"</span>,</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">                 <span class="dt">entry_script =</span> <span class="st">"accident-glm.R"</span>,</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">                 <span class="dt">script_params =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"--data_folder"</span> =<span class="st"> </span>ds<span class="op">$</span><span class="kw">path</span>(target_path)),</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">                 <span class="dt">compute_target =</span> compute_target)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/submit_experiment.html">submit_experiment</a></span>(exp, est)</a></code></pre></div>
<p>As usual, we can track the progress of the run in Azure ML by clicking on the “Web View” link displayed by this plot.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/plot_run_details.html">plot_run_details</a></span>(run)</a></code></pre></div>
<p>Now let’s submit scripts fitting K-nearest-neighbors and GLMnet models to the data. We’ll submit them to the same experiment, which will allow us to track and compare the accuracy of each model. In each script, the accuracy statistic is tracked with this line of code:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co">### DO NOT RUN THIS CODE CHUNK: tracking code from accident-XXX.R scripts</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/log_metric_to_run.html">log_metric_to_run</a></span>(<span class="st">"Accuracy"</span>,</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">                  <span class="kw">calc_acc</span>(<span class="dt">actual =</span> accident_tst<span class="op">$</span>dead,</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">                           <span class="dt">predicted =</span> <span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(accident_glmnet_mod, <span class="dt">newdata =</span> accident_tst))</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/log_metric_to_run.html">log_metric_to_run</a></span>(<span class="st">"Method"</span>, <span class="st">"GLMNET"</span>)</a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/log_metric_to_run.html">log_metric_to_run</a></span>(<span class="st">"TrainPCT"</span>, train.pct)</a></code></pre></div>
<p>We also track the algorithm used with the “Method” metric. (It’s not really a metric, but it’s useful to track in the Experiment view.) We also track the percentage of data used for the training set (the remainder is used for the test set, where accuracy is calculated). By default it is set to 75%, and we’ll see how to change that in the next session.</p>
<p>For now, submit expermiments for the KNN and GLMnet models:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">est &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/estimator.html">estimator</a></span>(<span class="dt">source_directory=</span><span class="st">"experiments-deep-dive"</span>,</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">                 <span class="dt">entry_script =</span> <span class="st">"accident-knn.R"</span>,</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">                 <span class="dt">script_params =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"--data_folder"</span> =<span class="st"> </span>ds<span class="op">$</span><span class="kw">path</span>(target_path)),</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">                 <span class="dt">compute_target =</span> compute_target)</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/submit_experiment.html">submit_experiment</a></span>(exp, est)</a>
<a class="sourceLine" id="cb7-6" data-line-number="6"></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">est &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/estimator.html">estimator</a></span>(<span class="dt">source_directory=</span><span class="st">"experiments-deep-dive"</span>,</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">                 <span class="dt">entry_script =</span> <span class="st">"accident-glmnet.R"</span>,</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">                 <span class="dt">script_params =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"--data_folder"</span> =<span class="st"> </span>ds<span class="op">$</span><span class="kw">path</span>(target_path)),</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">                 <span class="dt">compute_target =</span> compute_target)</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/submit_experiment.html">submit_experiment</a></span>(exp, est)</a></code></pre></div>
<p>At this point, it’s worth visiting <code>ml.azure.com</code> and taking a look at your training cluster: click on “Compute”, then “Training Clusters”, then “rcluster”. Note that the experiments are queued until a node in the cluster is available, and the cluster may even spin up a new node if the maximum nodes setting allows.</p>
<p>Also take a look at your experiment, by clicking on “Experiments” and then “accident”. You will see all of the runs you have submitted so far, along with their status (Completed or Running) and the Accuracy statistic you tracked. It’s likely that the GLM experiment has the highest accuracy, but this depends on the random split between the training and test partitions.</p>
<p>Speaking of the training percentage, the experiment scripts have been designed to accept a command-line argument to specify the proportion used for the training set. The code, which makes use of the <code>optparse</code> package, looks like this:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co">## DO NOT RUN THIS CODE CHUNK: options code from experiment script</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">options &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  <span class="kw">make_option</span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"-d"</span>, <span class="st">"--data_folder"</span>)),</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">  <span class="kw">make_option</span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"-p"</span>, <span class="st">"--percent_train"</span>))</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb8-6" data-line-number="6"></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">opt_parser &lt;-<span class="st"> </span><span class="kw">OptionParser</span>(<span class="dt">option_list =</span> options)</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">opt &lt;-<span class="st"> </span><span class="kw">parse_args</span>(opt_parser)</a>
<a class="sourceLine" id="cb8-9" data-line-number="9"></a>
<a class="sourceLine" id="cb8-10" data-line-number="10">train.pct &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(opt<span class="op">$</span>percent_train)</a></code></pre></div>
<p>We can use this option to pass in a value for the training percentage when we submit the experiment. Let’s submit three more experiments, setting the training percentage to 80%:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">train_pct_exp &lt;-<span class="st"> </span><span class="fl">0.80</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co">## GLM model</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">est &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/estimator.html">estimator</a></span>(<span class="dt">source_directory =</span> <span class="st">"experiments-deep-dive"</span>,</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">                 <span class="dt">entry_script =</span> <span class="st">"accident-glm.R"</span>,</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">                 <span class="dt">script_params =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"--data_folder"</span> =<span class="st"> </span>ds<span class="op">$</span><span class="kw">path</span>(target_path),</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">                                      <span class="st">"--percent_train"</span> =<span class="st"> </span>train_pct_exp),</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">                 <span class="dt">compute_target =</span> compute_target</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">)</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">run.glm &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/submit_experiment.html">submit_experiment</a></span>(exp, est)</a>
<a class="sourceLine" id="cb9-11" data-line-number="11"></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="co">## KNN model</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">exp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/experiment.html">experiment</a></span>(ws, <span class="st">"accident"</span>)</a>
<a class="sourceLine" id="cb9-14" data-line-number="14">est &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/estimator.html">estimator</a></span>(<span class="dt">source_directory =</span> <span class="st">"experiments-deep-dive"</span>, </a>
<a class="sourceLine" id="cb9-15" data-line-number="15">                 <span class="dt">entry_script =</span> <span class="st">"accident-knn.R"</span>,</a>
<a class="sourceLine" id="cb9-16" data-line-number="16">                 <span class="dt">script_params =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"--data_folder"</span> =<span class="st"> </span>ds<span class="op">$</span><span class="kw">path</span>(target_path),</a>
<a class="sourceLine" id="cb9-17" data-line-number="17">                                      <span class="st">"--percent_train"</span> =<span class="st"> </span>train_pct_exp),</a>
<a class="sourceLine" id="cb9-18" data-line-number="18">                 <span class="dt">compute_target =</span> compute_target</a>
<a class="sourceLine" id="cb9-19" data-line-number="19">)</a>
<a class="sourceLine" id="cb9-20" data-line-number="20">run.knn &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/submit_experiment.html">submit_experiment</a></span>(exp, est)</a>
<a class="sourceLine" id="cb9-21" data-line-number="21"></a>
<a class="sourceLine" id="cb9-22" data-line-number="22"><span class="co">## GLMNET model</span></a>
<a class="sourceLine" id="cb9-23" data-line-number="23">exp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/experiment.html">experiment</a></span>(ws, <span class="st">"accident"</span>)</a>
<a class="sourceLine" id="cb9-24" data-line-number="24">est &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/estimator.html">estimator</a></span>(<span class="dt">source_directory =</span> <span class="st">"experiments-deep-dive"</span>, </a>
<a class="sourceLine" id="cb9-25" data-line-number="25">                 <span class="dt">entry_script =</span> <span class="st">"accident-glmnet.R"</span>,</a>
<a class="sourceLine" id="cb9-26" data-line-number="26">                 <span class="dt">script_params =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"--data_folder"</span> =<span class="st"> </span>ds<span class="op">$</span><span class="kw">path</span>(target_path),</a>
<a class="sourceLine" id="cb9-27" data-line-number="27">                                      <span class="st">"--percent_train"</span> =<span class="st"> </span>train_pct_exp),</a>
<a class="sourceLine" id="cb9-28" data-line-number="28">                 <span class="dt">compute_target =</span> compute_target</a>
<a class="sourceLine" id="cb9-29" data-line-number="29">)</a>
<a class="sourceLine" id="cb9-30" data-line-number="30">run.glmnet &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/submit_experiment.html">submit_experiment</a></span>(exp, est)</a></code></pre></div>
<p>We can check the accuracy for our runs after they complete at <code>ml.azure.com</code>, or by querying the service directly:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/get_run_metrics.html">get_run_metrics</a></span>(run.glm)<span class="op">$</span>Accuracy</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/get_run_metrics.html">get_run_metrics</a></span>(run.knn)<span class="op">$</span>Accuracy</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/get_run_metrics.html">get_run_metrics</a></span>(run.glmnet)<span class="op">$</span>Accuracy</a></code></pre></div>
</div>
<div id="select-a-model-for-deployment" class="section level2">
<h2 class="hasAnchor">
<a href="#select-a-model-for-deployment" class="anchor"></a>Select a model for deployment</h2>
<p>There’s not a lot of differences between the accuracy of the models. We will deploy the GLMnet model, but you can deploy any of the models in the same way. The <code>caret</code> prediction interface is consistent across models, so you can use the same scoring script for all of them. We will deploy the model object along with the prediction script <code>accident_predict_caret.R</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/download_files_from_run.html">download_files_from_run</a></span>(run.glmnet, <span class="dt">prefix=</span><span class="st">"outputs/"</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">accident_model &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"outputs/model.rds"</span>)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">model &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/register_model.html">register_model</a></span>(ws, </a>
<a class="sourceLine" id="cb11-5" data-line-number="5">                        <span class="dt">model_path =</span> <span class="st">"outputs/model.rds"</span>, </a>
<a class="sourceLine" id="cb11-6" data-line-number="6">                        <span class="dt">model_name =</span> <span class="st">"accidents_model_caret"</span>,</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">                        <span class="dt">description =</span> <span class="st">"Predict probability of auto accident using caret"</span>)</a>
<a class="sourceLine" id="cb11-8" data-line-number="8"></a>
<a class="sourceLine" id="cb11-9" data-line-number="9">r_env &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/r_environment.html">r_environment</a></span>(<span class="dt">name =</span> <span class="st">"basic_env"</span>)</a>
<a class="sourceLine" id="cb11-10" data-line-number="10"></a>
<a class="sourceLine" id="cb11-11" data-line-number="11">inference_config &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/inference_config.html">inference_config</a></span>(</a>
<a class="sourceLine" id="cb11-12" data-line-number="12">  <span class="dt">entry_script =</span> <span class="st">"accident_predict_caret.R"</span>,</a>
<a class="sourceLine" id="cb11-13" data-line-number="13">  <span class="dt">source_directory =</span> <span class="st">"experiments-deep-dive"</span>,</a>
<a class="sourceLine" id="cb11-14" data-line-number="14">  <span class="dt">environment =</span> r_env)</a></code></pre></div>
</div>
<div id="deploy-a-model-to-azure-container-instances" class="section level2">
<h2 class="hasAnchor">
<a href="#deploy-a-model-to-azure-container-instances" class="anchor"></a>Deploy a model to Azure Container Instances</h2>
<p>Now we cam deploy our model as a container, to Azure Container Instances.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">aci_config &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/aci_webservice_deployment_config.html">aci_webservice_deployment_config</a></span>(<span class="dt">cpu_cores =</span> <span class="dv">1</span>, <span class="dt">memory_gb =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"></a>
<a class="sourceLine" id="cb12-3" data-line-number="3">aci_service &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/deploy_model.html">deploy_model</a></span>(ws, </a>
<a class="sourceLine" id="cb12-4" data-line-number="4">                            <span class="st">'accident-pred-caret'</span>, </a>
<a class="sourceLine" id="cb12-5" data-line-number="5">                            <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(model), </a>
<a class="sourceLine" id="cb12-6" data-line-number="6">                            inference_config, </a>
<a class="sourceLine" id="cb12-7" data-line-number="7">                            aci_config)</a>
<a class="sourceLine" id="cb12-8" data-line-number="8"></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/wait_for_deployment.html">wait_for_deployment</a></span>(aci_service, <span class="dt">show_output =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>If you wanted to deploy to Kubernetes, see the <a href="deploy-to-aks.Rmd">deploy-to-aks</a> vignette for an example.</p>
</div>
<div id="use-the-prediction-service-in-a-shiny-application" class="section level2">
<h2 class="hasAnchor">
<a href="#use-the-prediction-service-in-a-shiny-application" class="anchor"></a>Use the prediction service in a Shiny application</h2>
<p>We have provided the server and UI for a shiny application in the <code>accident-app</code> folder. The app uses the global variable <code>accident-endpoint</code> to find the endpoint of the prediction service to call, so set it here:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">accident.endpoint &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/get_webservice.html">get_webservice</a></span>(ws,   <span class="st">"accident-pred-caret"</span>)<span class="op">$</span>scoring_uri</a></code></pre></div>
<p>You can run the app by opening <code>app.R</code> in the <code>experiments-with-R/accident-app</code> folder in RStudio and clicking “Run App”, or by running the code below. Try out different values of the input variables to see how they affect the predicted probability of a fatal accident.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">shiny<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/shiny/man/runApp.html">runApp</a></span>(<span class="st">"experiments-with-R/accident-app"</span>)</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#a-deeper-dive-into-experiments">A Deeper Dive into Experiments</a></li>
      <li><a href="#load-the-data">Load the data</a></li>
      <li><a href="#try-out-several-models">Try out several models</a></li>
      <li><a href="#select-a-model-for-deployment">Select a model for deployment</a></li>
      <li><a href="#deploy-a-model-to-azure-container-instances">Deploy a model to Azure Container Instances</a></li>
      <li><a href="#use-the-prediction-service-in-a-shiny-application">Use the prediction service in a Shiny application</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Heemanshu Suri, Billy Hu, Diondra Peck, Minna Xiao, Microsoft.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>

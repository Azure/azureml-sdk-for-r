<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hyperparameter tune a Keras model • azuremlsdk</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Hyperparameter tune a Keras model">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">azuremlsdk</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.7.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/installation.html">Install the Azure ML SDK for R</a>
    </li>
    <li>
      <a href="../../articles/configuration.html">Set up an Azure ML workspace</a>
    </li>
    <li>
      <a href="../../articles/train-and-deploy-to-aci/train-and-deploy-to-aci.html">Train and deploy your first model with Azure ML</a>
    </li>
    <li>
      <a href="../../articles/train-with-tensorflow/train-with-tensorflow.html">Train a TensorFlow model</a>
    </li>
    <li>
      <a href="../../articles/hyperparameter-tune-with-keras/hyperparameter-tune-with-keras.html">Hyperparameter tune a Keras model</a>
    </li>
    <li>
      <a href="../../articles/deploy-to-aks/deploy-to-aks.html">Deploy a web service to Azure Kubernetes Service</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/azure/azureml-sdk-for-r">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Hyperparameter tune a Keras model</h1>
            
            <h4 class="date">2020-01-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/azure/azureml-sdk-for-r/blob/master/vignettes/hyperparameter-tune-with-keras/hyperparameter-tune-with-keras.Rmd"><code>vignettes/hyperparameter-tune-with-keras/hyperparameter-tune-with-keras.Rmd</code></a></small>
      <div class="hidden name"><code>hyperparameter-tune-with-keras.Rmd</code></div>

    </div>

    
    
<p>This tutorial demonstrates how you can efficiently tune hyperparameters for a model using HyperDrive, Azure ML’s hyperparameter tuning functionality. You will train a Keras model on the CIFAR10 dataset, automate hyperparameter exploration, launch parallel jobs, log your results, and find the best run.</p>
<div id="what-are-hyperparameters" class="section level3">
<h3 class="hasAnchor">
<a href="#what-are-hyperparameters" class="anchor"></a>What are hyperparameters?</h3>
<p>Hyperparameters are variable parameters chosen to train a model. Learning rate, number of epochs, and batch size are all examples of hyperparameters.</p>
<p>Using brute-force methods to find the optimal values for parameters can be time-consuming, and poor-performing runs can result in wasted money. To avoid this, HyperDrive automates hyperparameter exploration in a time-saving and cost-effective manner by launching several parallel runs with different configurations and finding the configuration that results in best performance on your primary metric.</p>
<p>Let’s get started with the example to see how it works!</p>
</div>
<div id="prerequisites" class="section level2">
<h2 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h2>
<p>If you don’t have access to an Azure ML workspace, follow the <a href="https://azure.github.io/azureml-sdk-for-r/articles/configuration.html">setup tutorial</a> to configure and create a workspace.</p>
</div>
<div id="set-up-development-environment" class="section level2">
<h2 class="hasAnchor">
<a href="#set-up-development-environment" class="anchor"></a>Set up development environment</h2>
<p>The setup for your development work in this tutorial includes the following actions:</p>
<ul>
<li>Import required packages</li>
<li>Connect to a workspace</li>
<li>Create an experiment to track your runs</li>
<li>Create a remote compute target to use for training</li>
</ul>
<div id="import-azuremlsdk-package" class="section level3">
<h3 class="hasAnchor">
<a href="#import-azuremlsdk-package" class="anchor"></a>Import <strong>azuremlsdk</strong> package</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(azuremlsdk)</a></code></pre></div>
</div>
<div id="load-your-workspace" class="section level3">
<h3 class="hasAnchor">
<a href="#load-your-workspace" class="anchor"></a>Load your workspace</h3>
<p>Instantiate a workspace object from your existing workspace. The following code will load the workspace details from a <strong>config.json</strong> file if you previously wrote one out with <a href="https://azure.github.io/azureml-sdk-for-r/reference/write_workspace_config.html"><code><a href="https://rdrr.io/pkg/azuremlsdk/man/write_workspace_config.html">write_workspace_config()</a></code></a>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">ws &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/load_workspace_from_config.html">load_workspace_from_config</a></span>()</a></code></pre></div>
<p>Or, you can retrieve a workspace by directly specifying your workspace details:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">ws &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/get_workspace.html">get_workspace</a></span>(<span class="st">"&lt;your workspace name&gt;"</span>, <span class="st">"&lt;your subscription ID&gt;"</span>, <span class="st">"&lt;your resource group&gt;"</span>)</a></code></pre></div>
</div>
<div id="create-an-experiment" class="section level3">
<h3 class="hasAnchor">
<a href="#create-an-experiment" class="anchor"></a>Create an experiment</h3>
<p>An Azure ML <strong>experiment</strong> tracks a grouping of runs, typically from the same training script. Create an experiment to track hyperparameter tuning runs for the Keras model.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">exp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/experiment.html">experiment</a></span>(<span class="dt">workspace =</span> ws, <span class="dt">name =</span> <span class="st">'hyperdrive-cifar10'</span>)</a></code></pre></div>
<p>If you would like to track your runs in an existing experiment, simply specify that experiment’s name to the <code>name</code> parameter of <code><a href="https://rdrr.io/pkg/azuremlsdk/man/experiment.html">experiment()</a></code>.</p>
</div>
<div id="create-a-compute-target" class="section level3">
<h3 class="hasAnchor">
<a href="#create-a-compute-target" class="anchor"></a>Create a compute target</h3>
<p>By using Azure Machine Learning Compute (AmlCompute), a managed service, data scientists can train machine learning models on clusters of Azure virtual machines. In this tutorial, you create a GPU-enabled cluster as your training environment. The code below creates the compute cluster for you if it doesn’t already exist in your workspace.</p>
<p>You may need to wait a few minutes for your compute cluster to be provisioned if it doesn’t already exist.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">cluster_name &lt;-<span class="st"> "gpucluster"</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">compute_target &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/get_compute.html">get_compute</a></span>(ws, <span class="dt">cluster_name =</span> cluster_name)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="cf">if</span> (<span class="kw"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(compute_target))</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">{</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  vm_size &lt;-<span class="st"> "STANDARD_NC6"</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  compute_target &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/create_aml_compute.html">create_aml_compute</a></span>(<span class="dt">workspace =</span> ws, </a>
<a class="sourceLine" id="cb5-8" data-line-number="8">                                       <span class="dt">cluster_name =</span> cluster_name,</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">                                       <span class="dt">vm_size =</span> vm_size, </a>
<a class="sourceLine" id="cb5-10" data-line-number="10">                                       <span class="dt">max_nodes =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb5-12" data-line-number="12">  <span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/wait_for_provisioning_completion.html">wait_for_provisioning_completion</a></span>(compute_target, <span class="dt">show_output =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">}</a></code></pre></div>
</div>
</div>
<div id="prepare-the-training-script" class="section level2">
<h2 class="hasAnchor">
<a href="#prepare-the-training-script" class="anchor"></a>Prepare the training script</h2>
<p>A training script called <code>cifar10_cnn.R</code> has been provided for you in the same directory as this tutorial.</p>
<p>In order to leverage HyperDrive, the training script for your model must log the relevant metrics during model training. When you configure the hyperparameter tuning run, you specify the primary metric to use for evaluating run performance. You must log this metric so it is available to the hyperparameter tuning process.</p>
<p>In order to log the required metrics, you need to do the following <strong>inside the training script</strong>:</p>
<ul>
<li>Import the <strong>azuremlsdk</strong> package</li>
</ul>
<pre><code><a href="https://rdrr.io/r/base/library.html">library(azuremlsdk)</a></code></pre>
<ul>
<li><p>Take the hyperparameters as command-line arguments to the script. This is necessary so that when HyperDrive carries out the hyperparameter sweep, it can run the training script with different values to the hyperparameters as defined by the search space.</p></li>
<li>Use the <a href="https://azure.github.io/azureml-sdk-for-r/reference/log_metric_to_run.html"><code><a href="https://rdrr.io/pkg/azuremlsdk/man/log_metric_to_run.html">log_metric_to_run()</a></code></a> function to log the hyperparameters and the primary metric.</li>
</ul>
<pre><code><a href="https://rdrr.io/pkg/azuremlsdk/man/log_metric_to_run.html">log_metric_to_run("batch_size", batch_size)
...
log_metric_to_run("epochs", epochs)
...
log_metric_to_run("lr", lr)
...
log_metric_to_run("decay", decay)
...
log_metric_to_run("Loss", results[[1]])</a></code></pre>
</div>
<div id="create-an-estimator" class="section level2">
<h2 class="hasAnchor">
<a href="#create-an-estimator" class="anchor"></a>Create an estimator</h2>
<p>An Azure ML <strong>estimator</strong> encapsulates the run configuration information needed for executing a training script on the compute target. Azure ML runs are run as containerized jobs on the specified compute target. By default, the Docker image built for your training job will include R, the Azure ML SDK, and a set of commonly used R packages. See the full list of default packages included <a href="https://azure.github.io/azureml-sdk-for-r/reference/r_environment.html">here</a>. The estimator is used to define the configuration for each of the child runs that the parent HyperDrive run will kick off.</p>
<p>To create the estimator, define the following:</p>
<ul>
<li>The directory that contains your scripts needed for training (<code>source_directory</code>). All the files in this directory are uploaded to the cluster node(s) for execution. The directory must contain your training script and any additional scripts required.</li>
<li>The training script that will be executed (<code>entry_script</code>).</li>
<li>The compute target (<code>compute_target</code>), in this case the AmlCompute cluster you created earlier.</li>
<li>Any environment dependencies required for training. Since the training script requires the Keras package, which is not included in the image by default, pass the package name to the <code>cran_packages</code> parameter to have it installed in the Docker container where the job will run. See the <a href="https://azure.github.io/azureml-sdk-for-r/reference/estimator.html"><code><a href="https://rdrr.io/pkg/azuremlsdk/man/estimator.html">estimator()</a></code></a> reference for the full set of configurable options.</li>
<li>Set the <code>use_gpu = TRUE</code> flag so the default base GPU Docker image will be built, since the job will be run on a GPU cluster.</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">est &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/estimator.html">estimator</a></span>(<span class="dt">source_directory =</span> <span class="st">"."</span>,</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">                 <span class="dt">entry_script =</span> <span class="st">"cifar10_cnn.R"</span>,</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">                 <span class="dt">compute_target =</span> compute_target,</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">                 <span class="dt">cran_packages =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"keras"</span>),</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">                 <span class="dt">use_gpu =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
</div>
<div id="configure-the-hyperdrive-run" class="section level2">
<h2 class="hasAnchor">
<a href="#configure-the-hyperdrive-run" class="anchor"></a>Configure the HyperDrive run</h2>
<p>To kick off hyperparameter tuning in Azure ML, you will need to configure a HyperDrive run, which will in turn launch individual children runs of the training scripts with the corresponding hyperparameter values.</p>
<div id="define-search-space" class="section level3">
<h3 class="hasAnchor">
<a href="#define-search-space" class="anchor"></a>Define search space</h3>
<p>In this experiment, we will use four hyperparameters: batch size, number of epochs, learning rate, and decay. In order to begin tuning, we must define the range of values we would like to explore from and how they will be distributed. This is called a parameter space definition and can be created with discrete or continuous ranges.</p>
<p><strong>Discrete hyperparameters</strong> are specified as a choice among discrete values represented as a list.</p>
<p>Advanced discrete hyperparameters can also be specified using a distribution. The following distributions are supported:</p>
<ul>
<li><code><a href="https://rdrr.io/pkg/azuremlsdk/man/quniform.html">quniform(low, high, q)</a></code></li>
<li><code><a href="https://rdrr.io/pkg/azuremlsdk/man/qloguniform.html">qloguniform(low, high, q)</a></code></li>
<li><code><a href="https://rdrr.io/pkg/azuremlsdk/man/qnormal.html">qnormal(mu, sigma, q)</a></code></li>
<li><code><a href="https://rdrr.io/pkg/azuremlsdk/man/qlognormal.html">qlognormal(mu, sigma, q)</a></code></li>
</ul>
<p><strong>Continuous hyperparameters</strong> are specified as a distribution over a continuous range of values. The following distributions are supported:</p>
<ul>
<li><code><a href="https://rdrr.io/pkg/azuremlsdk/man/uniform.html">uniform(low, high)</a></code></li>
<li><code><a href="https://rdrr.io/pkg/azuremlsdk/man/loguniform.html">loguniform(low, high)</a></code></li>
<li><code><a href="https://rdrr.io/pkg/azuremlsdk/man/normal.html">normal(mu, sigma)</a></code></li>
<li><code><a href="https://rdrr.io/pkg/azuremlsdk/man/lognormal.html">lognormal(mu, sigma)</a></code></li>
</ul>
<p>Here, we will use the <a href="https://azure.github.io/azureml-sdk-for-r/reference/random_parameter_sampling.html"><code><a href="https://rdrr.io/pkg/azuremlsdk/man/random_parameter_sampling.html">random_parameter_sampling()</a></code></a> function to define the search space for each hyperparameter. <code>batch_size</code> and <code>epochs</code> will be chosen from discrete sets while <code>lr</code> and <code>decay</code> will be drawn from continuous distributions.</p>
<p>Other available sampling function options are:</p>
<ul>
<li><a href="https://azure.github.io/azureml-sdk-for-r/reference/grid_parameter_sampling.html"><code><a href="https://rdrr.io/pkg/azuremlsdk/man/grid_parameter_sampling.html">grid_parameter_sampling()</a></code></a></li>
<li><a href="https://azure.github.io/azureml-sdk-for-r/reference/bayesian_parameter_sampling.html"><code><a href="https://rdrr.io/pkg/azuremlsdk/man/bayesian_parameter_sampling.html">bayesian_parameter_sampling()</a></code></a></li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">sampling &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/random_parameter_sampling.html">random_parameter_sampling</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">batch_size =</span> <span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/choice.html">choice</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">16</span>, <span class="dv">32</span>, <span class="dv">64</span>)),</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">                                           <span class="dt">epochs =</span> <span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/choice.html">choice</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">200</span>, <span class="dv">350</span>, <span class="dv">500</span>)),</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">                                           <span class="dt">lr =</span> <span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/normal.html">normal</a></span>(<span class="fl">0.0001</span>, <span class="fl">0.005</span>),</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">                                           <span class="dt">decay =</span> <span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/uniform.html">uniform</a></span>(<span class="fl">1e-6</span>, <span class="fl">3e-6</span>)))</a></code></pre></div>
</div>
<div id="define-termination-policy" class="section level3">
<h3 class="hasAnchor">
<a href="#define-termination-policy" class="anchor"></a>Define termination policy</h3>
<p>To prevent resource waste, Azure ML can detect and terminate poorly performing runs. HyperDrive will do this automatically if you specify an early termination policy.</p>
<p>Here, you will use the <a href="https://azure.github.io/azureml-sdk-for-r/reference/bandit_policy.html"><code><a href="https://rdrr.io/pkg/azuremlsdk/man/bandit_policy.html">bandit_policy()</a></code></a>, which terminates any runs where the primary metric is not within the specified slack factor with respect to the best performing training run.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">policy &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/bandit_policy.html">bandit_policy</a></span>(<span class="dt">slack_factor =</span> <span class="fl">0.15</span>)</a></code></pre></div>
<p>Other termination policy options are:</p>
<ul>
<li><a href="https://azure.github.io/azureml-sdk-for-r/reference/median_stopping_policy.html"><code><a href="https://rdrr.io/pkg/azuremlsdk/man/median_stopping_policy.html">median_stopping_policy()</a></code></a></li>
<li><a href="https://azure.github.io/azureml-sdk-for-r/reference/truncation_selection_policy.html"><code><a href="https://rdrr.io/pkg/azuremlsdk/man/truncation_selection_policy.html">truncation_selection_policy()</a></code></a></li>
</ul>
<p>If no policy is provided, all runs will continue to completion regardless of performance.</p>
</div>
<div id="finalize-configuration" class="section level3">
<h3 class="hasAnchor">
<a href="#finalize-configuration" class="anchor"></a>Finalize configuration</h3>
<p>Now, you can create a <code>HyperDriveConfig</code> object to define your HyperDrive run. Along with the sampling and policy definitions, you need to specify the name of the primary metric that you want to track and whether we want to maximize it or minimize it. The <code>primary_metric_name</code> must correspond with the name of the primary metric you logged in your training script. <code>max_total_runs</code> specifies the total number of child runs to launch. See the <a href="https://azure.github.io/azureml-sdk-for-r/reference/hyperdrive_config.html">hyperdrive_config()</a> reference for the full set of configurable parameters.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">hyperdrive_config &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/hyperdrive_config.html">hyperdrive_config</a></span>(<span class="dt">hyperparameter_sampling =</span> sampling,</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">                                       <span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/primary_metric_goal.html">primary_metric_goal</a></span>(<span class="st">"MINIMIZE"</span>),</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">                                       <span class="dt">primary_metric_name =</span> <span class="st">"Loss"</span>,</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">                                       <span class="dt">max_total_runs =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">                                       <span class="dt">policy =</span> policy,</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">                                       <span class="dt">estimator =</span> est)</a></code></pre></div>
</div>
</div>
<div id="submit-the-hyperdrive-run" class="section level2">
<h2 class="hasAnchor">
<a href="#submit-the-hyperdrive-run" class="anchor"></a>Submit the HyperDrive run</h2>
<p>Finally submit the experiment to run on your cluster. The parent HyperDrive run will launch the individual child runs. <code><a href="https://rdrr.io/pkg/azuremlsdk/man/submit_experiment.html">submit_experiment()</a></code> will return a <code>HyperDriveRun</code> object that you will use to interface with the run. In this tutorial, since the cluster we created scales to a max of <code>4</code> nodes, all 4 child runs will be launched in parallel.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">hyperdrive_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/submit_experiment.html">submit_experiment</a></span>(exp, hyperdrive_config)</a></code></pre></div>
<p>You can view the HyperDrive run’s details as a table. Clicking the “Web View” link provided will bring you to Azure Machine Learning studio, where you can monitor the run in the UI.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/view_run_details.html">view_run_details</a></span>(hyperdrive_run)</a></code></pre></div>
<p>Wait until hyperparameter tuning is complete before you run more code.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/wait_for_run_completion.html">wait_for_run_completion</a></span>(hyperdrive_run, <span class="dt">show_output =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
</div>
<div id="analyse-runs-by-performance" class="section level2">
<h2 class="hasAnchor">
<a href="#analyse-runs-by-performance" class="anchor"></a>Analyse runs by performance</h2>
<p>Finally, you can view and compare the metrics collected during all of the child runs!</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># Get the metrics of all the child runs</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2">child_run_metrics &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/get_child_run_metrics.html">get_child_run_metrics</a></span>(hyperdrive_run)</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">child_run_metrics</a>
<a class="sourceLine" id="cb15-4" data-line-number="4"></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co"># Get the child run objects sorted in descending order by the best primary metric</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6">child_runs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/get_child_runs_sorted_by_primary_metric.html">get_child_runs_sorted_by_primary_metric</a></span>(hyperdrive_run)</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">child_runs</a>
<a class="sourceLine" id="cb15-8" data-line-number="8"></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co"># Directly get the run object of the best performing run</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10">best_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/get_best_run_by_primary_metric.html">get_best_run_by_primary_metric</a></span>(hyperdrive_run)</a>
<a class="sourceLine" id="cb15-11" data-line-number="11"></a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="co"># Get the metrics of the best performing run</span></a>
<a class="sourceLine" id="cb15-13" data-line-number="13">metrics &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/get_run_metrics.html">get_run_metrics</a></span>(best_run)</a>
<a class="sourceLine" id="cb15-14" data-line-number="14">metrics</a></code></pre></div>
<p>The <code>metrics</code> variable will include the values of the hyperparameters that resulted in the best performing run.</p>
</div>
<div id="clean-up-resources" class="section level2">
<h2 class="hasAnchor">
<a href="#clean-up-resources" class="anchor"></a>Clean up resources</h2>
<p>Delete the resources once you no longer need them. Don’t delete any resource you plan to still use.</p>
<p>Delete the compute cluster:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/azuremlsdk/man/delete_compute.html">delete_compute</a></span>(compute_target)</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#prerequisites">Prerequisites</a></li>
      <li><a href="#set-up-development-environment">Set up development environment</a></li>
      <li><a href="#prepare-the-training-script">Prepare the training script</a></li>
      <li><a href="#create-an-estimator">Create an estimator</a></li>
      <li><a href="#configure-the-hyperdrive-run">Configure the HyperDrive run</a></li>
      <li><a href="#submit-the-hyperdrive-run">Submit the HyperDrive run</a></li>
      <li><a href="#analyse-runs-by-performance">Analyse runs by performance</a></li>
      <li><a href="#clean-up-resources">Clean up resources</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Heemanshu Suri, Billy Hu, Diondra Peck, Minna Xiao, Microsoft.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
